<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.faceontalk.mapper.FeedMapper">
	<!-- 피드리스트 + 페이지 처리 -->
	<select id="listSearch" resultType="FeedVO">
		select
			*
		from
			tbl_feed
		where 
			feed_no = 1		
		order by feed_no desc,regdate desc
		limit #{pageStart},#{perPageNum}
	</select>
	
	<!-- 피드 등록 -->
	<insert id="register">
	insert into tbl_feed
		(user_id_fk,user_name_fk,content,file_name)	
	values
		(#{user_id_fk}, #{user_name_fk}, #{content},#{file_name})	
	</insert>
	
	<!-- 피드 삭제 -->
	<delete id="remove">
		delete from tbl_feed where feed_no = #{feed_no}	
	</delete>
	

	<!-- 마지막에 삽입한 피드 번호 얻어오기 last_insert_id()는 커넥션마다 관리 have to retest -->	
	<select id="lastInserted" resultType="FeedVO">
		select feed_no from tbl_feed where feed_no = last_insert_id()
	</select>
	
	
	
	<!-- // hash tag // -->	
	<!-- 해시 태그 등록 -->
	<insert id="registerTag">
		insert into tbl_tag (tag_name) values (#{tag_name})
	</insert>	
	<select id="selectTagByName" resultType="hashTagVO">
		select * from tbl_tag where tag_name = #{tag_name}
	</select>
	
	<!-- 릴레이션 -->
	<insert id="registerRelation">
		insert into tbl_tagfeedrelations (feed_no,tag_id)
		values (#{feed_no},
			<choose>
		    <when test="tag_id != null">
		      #{tag_id}
		    </when>	    
		    <otherwise>
		      #{last_insert_id()}		      
		    </otherwise>
		  	</choose>		
		 )		
	</insert>
	
	
	
</mapper>

